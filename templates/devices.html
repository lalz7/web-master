{% extends "layout.html" %}

{% block title %}Kelola Perangkat{% endblock %}

{% block content %}
<!-- CSS untuk animasi feedback saat status berubah -->
<style>
    @keyframes flash-green {
      0%, 100% { background-color: #198754; box-shadow: none; }
      50% { background-color: #20c997; box-shadow: 0 0 12px #20c997; }
    }
    @keyframes flash-gray {
      0%, 100% { background-color: #6c757d; box-shadow: none; }
      50% { background-color: #adb5bd; box-shadow: 0 0 12px #adb5bd; }
    }
    @keyframes flash-red {
      0%, 100% { background-color: #dc3545; box-shadow: none; }
      50% { background-color: #f1737d; box-shadow: 0 0 12px #f1737d; }
    }
    .flash-success { animation: flash-green 1s ease-out; }
    .flash-offline { animation: flash-gray 1s ease-out; }
    .flash-error { animation: flash-red 1s ease-out; }
</style>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-server me-2"></i>Kelola Perangkat</h5>
        <!-- Tombol untuk memicu modal tambah perangkat -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
            <i class="fas fa-plus me-1"></i> Tambah Perangkat
        </button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="devicesTable" class="table table-hover" style="width:100%">
                <thead class="table-dark">
                    <tr>
                        <th>IP Address</th>
                        <th>Nama</th>
                        <th>Lokasi</th>
                        <th>Sync Terakhir</th>
                        <th>Status</th>
                        <th class="no-sort text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    <tr>
                        <td>{{ device.ip }}</td>
                        <!-- Nama perangkat bisa diklik untuk memfilter log event -->
                        <td><a href="{{ url_for('events', device=device.name) }}" class="fw-bold text-decoration-none">{{ device.name }}</a></td>
                        <td>{{ device.location or '-' }}</td>
                        <!-- Atribut data-ip-sync digunakan oleh JavaScript untuk update real-time -->
                        <td data-ip-sync="{{ device.ip }}">{{ device.lastSync.strftime('%d-%m-%Y %H:%M:%S') if device.lastSync else 'Belum pernah' }}</td>
                        <td>
                            <!-- Badge status dengan ID unik untuk update via JavaScript -->
                            <span id="status-{{ device.ip.replace('.', '-') }}" class="badge {% if device.status == 'online' %}bg-success{% elif device.status == 'offline' %}bg-secondary{% elif device.status == 'error' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                {{ device.status }}
                            </span>
                        </td>
                        <td class="text-center">
                            <!-- Tombol aksi untuk setiap perangkat -->
                            <button class="btn btn-sm btn-outline-primary ping-btn" data-ip="{{ device.ip }}" title="Live Ping"><i class="fas fa-wifi"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#editModal-{{ device.ip.replace('.', '-') }}" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-ip="{{ device.ip }}" data-name="{{ device.name }}" title="Hapus"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="text-center">Belum ada perangkat yang ditambahkan.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal untuk Tambah Perangkat Baru -->
<div class="modal fade" id="addDeviceModal" tabindex="-1" aria-labelledby="addDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('add_device') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="addDeviceModalLabel"><i class="fas fa-plus-circle me-2"></i>Tambah Perangkat Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="ip" class="form-label">IP Address</label>
                        <input type="text" class="form-control" name="ip" placeholder="Contoh: 192.168.1.10" required>
                    </div>
                    <div class="mb-3">
                        <label for="name" class="form-label">Nama Perangkat</label>
                        <input type="text" class="form-control" name="name" placeholder="Contoh: Kamera Lobi Depan" required>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Lokasi</label>
                        <input type="text" class="form-control" name="location" placeholder="Contoh: Gedung A">
                    </div>
                     <hr>
                     <p class="text-muted small">Kredensial untuk mengakses perangkat:</p>
                     <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label for="targetApi" class="form-label">Target API URL (Opsional)</label>
                        <input type="url" class="form-control" name="targetApi" placeholder="https://tujuan-api.com/endpoint">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loop untuk membuat Modal Edit untuk SETIAP perangkat -->
{% for device in devices %}
<div class="modal fade" id="editModal-{{ device.ip.replace('.', '-') }}" tabindex="-1" aria-labelledby="editModalLabel-{{ device.ip.replace('.', '-') }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('update_device') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel-{{ device.ip.replace('.', '-') }}"><i class="fas fa-edit me-2"></i>Edit Perangkat</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="ip" value="{{ device.ip }}">
                    <div class="mb-3">
                        <label class="form-label">IP Address</label>
                        <input type="text" class="form-control" value="{{ device.ip }}" disabled readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nama Perangkat</label>
                        <input type="text" class="form-control" name="name" value="{{ device.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lokasi</label>
                        <input type="text" class="form-control" name="location" value="{{ device.location or '' }}">
                    </div>
                    <hr>
                    <p class="text-muted small">Ubah kredensial perangkat:</p>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" value="{{ device.username }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Password Baru</label>
                            <input type="password" class="form-control" name="password" placeholder="Isi untuk mengubah">
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">Target API URL (Opsional)</label>
                        <input type="url" class="form-control" name="targetApi" value="{{ device.targetApi or '' }}" placeholder="https://tujuan-api.com/endpoint">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Form Hapus (tersembunyi), digunakan oleh SweetAlert -->
<form id="deleteForm" method="POST" action=""><input type="hidden" name="ip" id="deleteIp"></form>
{% endblock %}

{% block scripts %}
<!-- Memuat library jQuery, DataTables, dan SweetAlert2 -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function() {
    // 1. Inisialisasi DataTables untuk membuat tabel interaktif
    $('#devicesTable').DataTable({
        "order": [[ 0, "asc" ]], // Urutkan berdasarkan IP secara default
        "language": {
            "search": "Cari:",
            "lengthMenu": "Tampilkan _MENU_ entri",
            "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
            "paginate": { "next": "Berikutnya", "previous": "Sebelumnya" }
        },
        "columnDefs": [ { "targets": 'no-sort', "orderable": false } ] // Matikan pengurutan untuk kolom Aksi
    });

    // 2. Logika untuk tombol Live Ping
    const PING_TIMEOUT = 15000; // Batas waktu 15 detik untuk permintaan ping
    // Fungsi helper untuk fetch dengan timeout
    const fetchWithTimeout = (resource, options = {}) => {
        return Promise.race([
            fetch(resource, options),
            new Promise((_, reject) =>
                setTimeout(() => reject(new Error('Permintaan melewati batas waktu (timeout)')), PING_TIMEOUT)
            )
        ]);
    };
    // Event listener untuk semua tombol dengan kelas .ping-btn
    $('#devicesTable').on('click', '.ping-btn', function() {
        const button = $(this);
        const ip = button.data('ip');
        const originalIcon = button.html();
        const statusBadge = $('#status-' + ip.replace(/\./g, '-'));

        // Beri feedback visual bahwa ping sedang berlangsung
        button.html('<span class="spinner-border spinner-border-sm" role="status"></span>').prop('disabled', true);
        statusBadge.removeClass('bg-success bg-secondary bg-danger flash-success flash-offline flash-error').addClass('bg-warning text-dark').text('memeriksa...');

        fetchWithTimeout(`/api/ping/${ip}`, {})
            .then(response => {
                if (!response.ok) { throw new Error('Gagal koneksi.'); }
                return response.json();
            })
            .then(data => {
                statusBadge.removeClass('bg-warning text-dark');
                let finalStatus = data.status === 'online' ? 'online' : 'offline';
                let finalBadgeClass = finalStatus === 'online' ? 'bg-success flash-success' : 'bg-secondary flash-offline';
                statusBadge.addClass(finalBadgeClass).text(finalStatus);
                pollDeviceStatus(); // Panggil polling segera setelah ping untuk data terbaru
                setTimeout(() => { statusBadge.removeClass('flash-success flash-offline'); }, 1000); // Hapus class animasi
            })
            .catch(error => {
                console.error('Ping error:', error);
                statusBadge.removeClass('bg-warning text-dark').addClass('bg-secondary flash-offline').text('offline');
                pollDeviceStatus(); // Panggil polling juga saat gagal
                setTimeout(() => { statusBadge.removeClass('flash-offline'); }, 1000);
            })
            .finally(() => {
                // Kembalikan tombol ke keadaan semula
                button.html(originalIcon).prop('disabled', false);
            });
    });

    // 3. Logika Auto-Refresh Status (Polling)
    function pollDeviceStatus() {
        $.ajax({
            url: '/api/devices_status', // Panggil API yang memberikan status semua perangkat
            method: 'GET',
            dataType: 'json',
            success: function(devicesData) {
                devicesData.forEach(function(device) {
                    const statusBadge = $('#status-' + device.ip.replace(/\./g, '-'));
                    const lastSyncCell = $(`td[data-ip-sync="${device.ip}"]`);
                    
                    // Update badge status jika ada perubahan dan tidak sedang di-ping manual
                    if (statusBadge.length && !statusBadge.text().includes('memeriksa')) {
                        let newStatusText = device.status;
                        let newBadgeClass = (device.status === 'online') ? 'bg-success' : 
                                            (device.status === 'offline') ? 'bg-secondary' : 'bg-danger';
                        if (!statusBadge.hasClass(newBadgeClass.split(' ')[0]) || statusBadge.text() !== newStatusText) {
                            statusBadge.removeClass('bg-success bg-secondary bg-danger bg-warning text-dark').addClass(newBadgeClass).text(newStatusText);
                        }
                    }

                    // Update waktu "Sync Terakhir" jika ada perubahan
                    if (lastSyncCell.length && lastSyncCell.text() !== (device.lastSync || 'Belum pernah')) {
                        lastSyncCell.text(device.lastSync || 'Belum pernah');
                    }
                });
            },
            error: function(xhr, status, error) {
                console.warn("Gagal melakukan polling status:", status, error);
            }
        });
    }
    setInterval(pollDeviceStatus, 15000); // Jalankan polling setiap 15 detik

    // 4. Logika untuk tombol Hapus dengan konfirmasi SweetAlert
    $('#devicesTable').on('click', '.delete-btn', function(e) {
        e.preventDefault();
        const ip = $(this).data('ip');
        const name = $(this).data('name');
        const deleteForm = $('#deleteForm');
        
        Swal.fire({
            title: 'Anda Yakin?',
            text: `Perangkat "${name}" (${ip}) akan dihapus permanen!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, hapus!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                // Jika dikonfirmasi, isi form tersembunyi dan submit
                $('#deleteIp').val(ip);
                deleteForm.attr('action', "{{ url_for('delete_device') }}").submit();
            }
        });
    });
});
</script>
{% endblock %}
