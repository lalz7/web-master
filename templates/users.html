{% extends "layout.html" %}

{% block title %}Kelola Pengguna - {{ device.name }}{% endblock %}

{% block content %}
<style>
    /* Perataan vertikal agar rapi */
    #usersTable th,
    #usersTable td {
        vertical-align: middle;
    }
    /* Jarak antar tombol aksi */
    .btn-action-group .btn {
        margin: 0 0.15rem;
    }
</style>

<div class="card">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>{{ device.name }} - {{ device.location or 'Tanpa Lokasi' }}</h5>
        <div>
            <button type="button" class="btn btn-secondary" id="refreshBtn" title="Muat Ulang Data">
                <i class="fas fa-sync-alt"></i>
            </button>
            
            <button type="button" class="btn btn-warning text-dark" id="bulkExpiryBtn" style="display: none;">
                <i class="fas fa-clock me-1"></i> Atur Expired (<span id="selected-count">0</span>)
            </button>

            <button type="button" class="btn btn-primary" id="addUserBtn">
                <i class="fas fa-user-plus me-1"></i> Tambah Pengguna
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="notification-area" class="mb-3" style="display: none;"></div>
        
        <div id="loading-spinner" class="text-center my-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3 text-muted">Mengambil data dari perangkat...</p>
        </div>

        <div class="table-responsive" id="table-container" style="display: none;">
            <table id="usersTable" class="table table-hover" style="width:100%">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 5%;" class="text-center">
                            <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        <th style="width: 10%;">Id</th>
                        <th style="width: 35%;">Nama</th>
                        <th style="width: 15%;">Jenis Kelamin</th>
                        <th style="width: 25%;">Masa Berlaku</th>
                        <th class="no-sort" style="width: 10%;">Aksi</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkExpiryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Atur Masa Berlaku (Expired)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i> Anda akan mengubah waktu akses untuk <strong id="modal-selected-count">0</strong> pengguna yang dipilih.
                </div>
                <form id="bulkExpiryForm">
                    <div class="mb-3">
                        <label class="form-label">Waktu Mulai (Start Time)</label>
                        <input type="datetime-local" class="form-control" id="bulk-start-time" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Waktu Berakhir (Expired Time)</label>
                        <input type="datetime-local" class="form-control" id="bulk-end-time" required>
                        <div class="form-text text-muted">Default: Hari ini pukul 17:00.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="saveBulkExpiryBtn">Simpan Perubahan</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Pengguna</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="edit-notification-area"></div>
        <form id="editUserForm">
            <input type="hidden" id="edit-employee-no-hidden">
            <div class="row">
                <div class="col-md-7">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-employee-no" class="form-label">ID Karyawan</label>
                            <input type="text" class="form-control" id="edit-employee-no" disabled>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-user-gender" class="form-label">Jenis Kelamin</label>
                            <select id="edit-user-gender" class="form-select">
                                <option value="unknown">Tidak Diketahui</option>
                                <option value="male">Laki-laki</option>
                                <option value="female">Perempuan</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit-user-name" class="form-label">Nama Lengkap</label>
                        <input type="text" class="form-control" id="edit-user-name" required>
                    </div>
                    
                    <hr class="my-3">
                    <h6 class="mb-3"><i class="fas fa-clock me-1"></i> Masa Berlaku Akses</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit-start-time" class="form-label">Waktu Mulai</label>
                            <input type="datetime-local" class="form-control" id="edit-start-time" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit-end-time" class="form-label">Waktu Akhir</label>
                            <input type="datetime-local" class="form-control" id="edit-end-time" required>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <label for="edit-photo-input" class="form-label">Ganti Foto Wajah (Opsional)</label>
                    <div id="edit-photo-preview-container" class="text-center mb-2" style="display: none;">
                        <img id="edit-photo-preview" src="#" alt="Preview Gambar" class="img-fluid rounded border p-1" style="max-height: 220px;">
                    </div>
                    <input class="form-control" type="file" id="edit-photo-input" accept="image/jpeg, image/png">
                    <small class="form-text mt-1 d-block">Kosongkan jika tidak ingin mengganti foto.</small>
                    <small id="edit-photo-validation-text" class="form-text mt-1 d-block"></small>
                </div>
            </div>
        </form>
      </div>
      <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-primary" id="saveUserChangesBtn">Simpan Perubahan</button>
        </div>
    </div>
  </div>
</div>

<div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Tambah Pengguna Baru</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="add-notification-area"></div>
        <form id="addUserForm" onsubmit="return false;">
            <div class="row">
                <div class="col-md-7">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="add-employee-no" class="form-label">ID Karyawan</label><input type="number" class="form-control" id="add-employee-no" min="1" required><small class="form-text text-muted">Pastikan ID unik.</small></div>
                        <div class="col-md-6 mb-3">
                            <label for="add-user-gender" class="form-label">Jenis Kelamin</label>
                            <select id="add-user-gender" class="form-select"><option value="unknown">Tidak Diketahui</option><option value="male">Laki-laki</option><option value="female">Perempuan</option></select>
                        </div>
                    </div>
                    <div class="mb-3"><label for="add-user-name" class="form-label">Nama Lengkap</label><input type="text" class="form-control" id="add-user-name" required></div>
                    
                    <hr class="my-3">
                    <h6 class="mb-3"><i class="fas fa-clock me-1"></i> Masa Berlaku Akses</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="add-start-time" class="form-label">Waktu Mulai</label><input type="datetime-local" class="form-control" id="add-start-time" required></div>
                        <div class="col-md-6 mb-3"><label for="add-end-time" class="form-label">Waktu Akhir</label><input type="datetime-local" class="form-control" id="add-end-time" required></div>
                    </div>
                </div>
                <div class="col-md-5">
                    <label for="add-photo-input" class="form-label">Foto Wajah (Opsional)</label>
                    <div id="add-photo-preview-container" class="text-center mb-2" style="display: none;">
                        <img id="add-photo-preview" src="#" alt="Preview Gambar" class="img-fluid rounded border p-1" style="max-height: 220px;">
                    </div>
                    <input class="form-control" type="file" id="add-photo-input" accept="image/jpeg, image/png">
                    <small id="add-photo-validation-text" class="form-text mt-1 d-block"></small>
                </div>
            </div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="addNewUserBtn">Tambah</button></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function() {
    const deviceIp = "{{ device.ip }}";
    const tableElement = $('#usersTable');
    let dataTable, usersDataCache = [];

    // --- UTILITIES ---
    const getNowDateTime = () => new Date(new Date() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    const getFutureDateTime = (years) => { const d = new Date(); d.setFullYear(d.getFullYear() + years); return new Date(d - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16); };
    
    // [BARU] Fungsi untuk mendapatkan hari ini pukul 17:00:00
    const getTodayAt17 = () => {
        const d = new Date();
        d.setHours(17, 0, 0, 0);
        return new Date(d - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    };

    const getGenderDisplay = gender => (gender === 'male' ? 'Laki-laki' : (gender === 'female' ? 'Perempuan' : '-'));
    const showNotification = (message, type = 'success', area = $('#notification-area')) => area.html(`<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`).fadeIn().delay(5000).fadeOut();
    
    const formatISODateForInput = (isoString) => {
        if (!isoString) return getNowDateTime();
        return isoString.split('+')[0].slice(0, 16);
    };
    
    const formatDisplayDate = (isoString) => {
        if(!isoString) return '-';
        try {
            const parts = isoString.split('T');
            const datePart = parts[0].split('-'); 
            
            // Ambil jam dan menit (HH:mm)
            let timePart = "00:00";
            if (parts[1]) {
                timePart = parts[1].split('+')[0].substring(0, 5);
            }
            
            return `${datePart[2]}/${datePart[1]}/${datePart[0]} ${timePart}`;
        } catch(e) { return isoString; }
    };

    // --- DATA LOADING ---
    function loadUsers() {
        $('#loading-spinner').show(); $('#table-container').hide(); $('#notification-area').hide();
        $('#bulkExpiryBtn').hide(); 
        $('#selectAll').prop('checked', false); 

        if (dataTable) { dataTable.destroy(); tableElement.find('tbody').empty(); }

        fetch(`/api/devices/${deviceIp}/users`)
            .then(res => res.ok ? res.json() : res.json().then(err => { throw new Error(err.error); }))
            .then(users => {
                usersDataCache = users; 
                const tableBody = tableElement.find('tbody');
                if (users.length === 0) {
                    tableBody.html('<tr><td colspan="6" class="text-center text-muted py-5">Tidak ada pengguna.</td></tr>');
                } else {
                    users.forEach(user => {
                        const gender = getGenderDisplay(user.gender);
                        // Ambil masa berlaku untuk display
                        let expiryDisplay = '-';
                        if (user.Valid && user.Valid.endTime) {
                            expiryDisplay = formatDisplayDate(user.Valid.endTime);
                        }
                        
                        tableBody.append(`<tr>
                            <td class="text-center">
                                <input type="checkbox" class="form-check-input user-select" value="${user.employeeNo}" data-name="${user.name}">
                            </td>
                            <td><strong>${user.employeeNo}</strong></td>
                            <td>${user.name}</td>
                            <td>${gender}</td>
                            <td>${expiryDisplay}</td>
                            <td class="btn-action-group">
                                <button class="btn btn-sm btn-outline-warning edit-btn" data-id="${user.employeeNo}" title="Edit Data"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${user.employeeNo}" data-name="${user.name}" title="Hapus Pengguna"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`);
                    });
                }
                
                dataTable = tableElement.DataTable({
                    "order": [[1, "asc"]], 
                    "language": {
                        "search": "Cari:",
                        "lengthMenu": "Tampilkan _MENU_ entri",
                        "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
                        "paginate": { "next": "Berikutnya", "previous": "Sebelumnya" }
                    },
                    "columnDefs": [
                        { "orderable": false, "targets": 0 }, 
                        { "orderable": false, "targets": 5 }, 
                        { "className": "text-center", "targets": 0 },
                        { "className": "text-right", "targets": 1 },
                        { "className": "text-left", "targets": 2 },
                        { "className": "text-left", "targets": 3 },
                        { "className": "text-center", "targets": 4 },
                        { "className": "text-center", "targets": 5 }
                    ]
                });
                $('#table-container').fadeIn();
            })
            .catch(error => showNotification(`<strong>Gagal ambil data.</strong><br>${error.message}`, 'danger'))
            .finally(() => $('#loading-spinner').hide());
    }

    // --- LOGIKA CHECKBOX & BULK ACTION ---
    
    $('#selectAll').on('change', function() {
        const isChecked = $(this).is(':checked');
        $('.user-select').prop('checked', isChecked).trigger('change');
    });

    tableElement.on('change', '.user-select', function() {
        const selectedCount = $('.user-select:checked').length;
        $('#selected-count').text(selectedCount);
        
        if (selectedCount > 0) {
            $('#bulkExpiryBtn').fadeIn();
        } else {
            $('#bulkExpiryBtn').fadeOut();
            $('#selectAll').prop('checked', false);
        }
    });

    const bulkModal = new bootstrap.Modal(document.getElementById('bulkExpiryModal'));
    
    $('#bulkExpiryBtn').on('click', function() {
        const selectedCount = $('.user-select:checked').length;
        $('#modal-selected-count').text(selectedCount);
        
        // [MODIFIKASI] Set default time: Hari ini pukul 17:00
        $('#bulk-start-time').val(getNowDateTime());
        $('#bulk-end-time').val(getTodayAt17()); // Menggunakan fungsi baru

        bulkModal.show();
    });

    $('#saveBulkExpiryBtn').on('click', async function() {
        const startTime = $('#bulk-start-time').val();
        const endTime = $('#bulk-end-time').val();
        
        if (!startTime || !endTime) {
            Swal.fire('Error', 'Waktu mulai dan berakhir harus diisi.', 'error');
            return;
        }

        const selectedUsers = [];
        $('.user-select:checked').each(function() {
            selectedUsers.push({
                employeeNo: $(this).val(),
                name: $(this).data('name') 
            });
        });

        if (selectedUsers.length === 0) return;

        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Menyimpan...');

        try {
            const res = await fetch(`/api/devices/${deviceIp}/users/bulk_update_expiry`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    users: selectedUsers,
                    startTime: startTime,
                    endTime: endTime
                })
            });
            
            const data = await res.json();
            
            if (res.ok) {
                bulkModal.hide();
                Swal.fire({
                    title: 'Berhasil!',
                    text: data.message,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                loadUsers();
            } else {
                throw new Error(data.error || 'Gagal update massal.');
            }
        } catch (error) {
            Swal.fire('Gagal!', error.message, 'error');
        } finally {
            btn.prop('disabled', false).html('Simpan Perubahan');
        }
    });


    // --- FITUR LAMA (EDIT, ADD, DELETE) ---
    const editModal = new bootstrap.Modal($('#editUserModal')[0]);
    
    tableElement.on('click', '.edit-btn', function() {
        const user = usersDataCache.find(u => u.employeeNo == $(this).data('id'));
        if (!user) return;
        
        $('#editUserForm')[0].reset();
        $('#edit-notification-area').empty();
        $('#edit-photo-preview-container').hide();
        $('#edit-photo-validation-text').text('');
        $('#addNewUserBtn').prop('disabled', false); 

        $('#edit-employee-no').val(user.employeeNo);
        $('#edit-employee-no-hidden').val(user.employeeNo); 
        $('#edit-user-name').val(user.name);
        $('#edit-user-gender').val(user.gender || 'unknown');
        
        let beginTime = getNowDateTime();
        let endTime = getFutureDateTime(10);
        if (user.Valid) {
            beginTime = formatISODateForInput(user.Valid.beginTime);
            endTime = formatISODateForInput(user.Valid.endTime);
        }
        $('#edit-start-time').val(beginTime);
        $('#edit-end-time').val(endTime);

        editModal.show();
    });

    // Validasi Foto
    $('#edit-photo-input, #add-photo-input').on('change', function() {
        const file = this.files[0];
        const isAdd = $(this).attr('id') === 'add-photo-input';
        const validationText = isAdd ? $('#add-photo-validation-text') : $('#edit-photo-validation-text');
        const previewContainer = isAdd ? $('#add-photo-preview-container') : $('#edit-photo-preview-container');
        const previewImage = isAdd ? $('#add-photo-preview') : $('#edit-photo-preview');
        const btn = isAdd ? $('#addNewUserBtn') : $('#saveUserChangesBtn');
        btn.prop('disabled', false);

        if (!file) { previewContainer.hide(); validationText.text(''); return; }
        if (!['image/jpeg', 'image/png'].includes(file.type)) {
            validationText.text('Format file harus JPG atau PNG.').removeClass('text-success').addClass('text-danger');
            previewContainer.hide(); $(this).val(''); btn.prop('disabled', true); return;
        }
        if (file.size > 200 * 1024) {
            validationText.text(`Ukuran file terlalu besar. Maks 200KB.`).removeClass('text-success').addClass('text-danger');
            previewContainer.hide(); $(this).val(''); btn.prop('disabled', true); return;
        }
        validationText.text(`OK (${(file.size/1024).toFixed(0)} KB)`).removeClass('text-danger').addClass('text-success');
        const reader = new FileReader();
        reader.onload = e => { previewImage.attr('src', e.target.result); previewContainer.show(); };
        reader.readAsDataURL(file);
    });

    // Simpan Perubahan Individual (Edit)
    $('#saveUserChangesBtn').on('click', async function() {
        if (!document.getElementById('editUserForm').checkValidity()) { document.getElementById('editUserForm').reportValidity(); return; }
        const btn = $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Menyimpan...');
        const formData = new FormData();
        const empNo = $('#edit-employee-no-hidden').val();
        formData.append('employeeNo', empNo);
        formData.append('name', $('#edit-user-name').val());
        formData.append('gender', $('#edit-user-gender').val());
        formData.append('startTime', $('#edit-start-time').val());
        formData.append('endTime', $('#edit-end-time').val());
        const photoFile = $('#edit-photo-input')[0].files[0];
        if (photoFile) formData.append('photo', photoFile);

        try {
            const res = await fetch(`/api/devices/${deviceIp}/users/${empNo}/update`, { method: 'POST', body: formData });
            const resData = await res.json();
            if (!res.ok) throw new Error(resData.error || resData.warning);
            showNotification('Berhasil disimpan!', 'success');
            editModal.hide(); setTimeout(loadUsers, 1500);
        } catch (error) {
            showNotification(error.message, 'danger', $('#edit-notification-area'));
        } finally {
            btn.prop('disabled', false).html('Simpan Perubahan');
        }
    });

    // Hapus Individual
    tableElement.on('click', '.delete-btn', function() {
        const empNo = $(this).data('id');
        const userName = $(this).data('name');
        Swal.fire({
            title: 'Konfirmasi Hapus', text: `Yakin ingin menghapus "${userName}" (${empNo})?`, icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
        }).then(async result => {
            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/devices/${deviceIp}/users/${empNo}/delete`, { method: 'DELETE' });
                    if (!res.ok) throw new Error((await res.json()).error);
                    Swal.fire('Terhapus!', 'Pengguna berhasil dihapus.', 'success'); loadUsers();
                } catch (error) { Swal.fire('Gagal!', error.message, 'error'); }
            }
        });
    });

    // Tambah User Baru
    const addModal = new bootstrap.Modal($('#addUserModal')[0]);
    $('#addUserBtn').on('click', () => {
        $('#addUserForm')[0].reset(); $('#add-notification-area').empty();
        $('#add-photo-preview-container').hide(); $('#add-start-time').val(getNowDateTime());
        $('#add-end-time').val(getFutureDateTime(10)); addModal.show();
    });

    $('#addNewUserBtn').on('click', async function() {
        if (!document.getElementById('addUserForm').checkValidity()) { document.getElementById('addUserForm').reportValidity(); return; }
        const btn = $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Menambah...');
        const formData = new FormData();
        formData.append('employeeNo', $('#add-employee-no').val());
        formData.append('name', $('#add-user-name').val());
        formData.append('gender', $('#add-user-gender').val());
        formData.append('startTime', $('#add-start-time').val());
        formData.append('endTime', $('#add-end-time').val());
        const photoFile = $('#add-photo-input')[0].files[0];
        if (photoFile) formData.append('photo', photoFile);

        try {
            const res = await fetch(`/api/devices/${deviceIp}/users/add`, { method: 'POST', body: formData });
            const resData = await res.json();
            if (!res.ok) throw new Error(resData.error);
            showNotification('Pengguna berhasil ditambahkan!', 'success'); addModal.hide(); setTimeout(loadUsers, 1500);
        } catch (error) {
            showNotification(error.message, 'danger', $('#add-notification-area'));
        } finally {
            btn.prop('disabled', false).html('Tambah');
        }
    });

    // Init
    loadUsers();
    $('#refreshBtn').on('click', loadUsers);
});
</script>
{% endblock %}