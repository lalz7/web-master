{% extends "layout.html" %}

{% block title %}Pengaturan{% endblock %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="card">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="settingsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="security-tab" data-bs-toggle="tab" data-bs-target="#security-pane" type="button" role="tab" aria-controls="security-pane" aria-selected="true">
                    <i class="fas fa-key me-2"></i>Keamanan
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="retention-tab" data-bs-toggle="tab" data-bs-target="#retention-pane" type="button" role="tab" aria-controls="retention-pane" aria-selected="false">
                    <i class="fas fa-database me-2"></i>Database
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notif-tab" data-bs-toggle="tab" data-bs-target="#notif-pane" type="button" role="tab" aria-controls="notif-pane" aria-selected="false">
                    <i class="fab fa-whatsapp me-2"></i>Notifikasi
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sync-tab" data-bs-toggle="tab" data-bs-target="#sync-pane" type="button" role="tab" aria-controls="sync-pane" aria-selected="false">
                    <i class="fas fa-sync-alt me-2"></i>Sinkronisasi
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced-pane" type="button" role="tab" aria-controls="advanced-pane" aria-selected="false">
                    <i class="fas fa-cogs me-2"></i>Lanjutan
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body p-4">
        <div class="tab-content" id="settingsTabsContent">
            
            <div class="tab-pane fade show active" id="security-pane" role="tabpanel" aria-labelledby="security-tab">
                <h5 class="mb-4">Ubah Password Admin</h5>
                <form action="{{ url_for('save_password_settings') }}" method="POST">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">Password Saat Ini</label>
                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_password" class="form-label">Password Baru</label>
                        <input type="password" class="form-control" id="new_password" name="new_password" minlength="6" required>
                        <div class="form-text">Minimal 6 karakter.</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">Konfirmasi Password Baru</label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" minlength="6" required>
                    </div>
                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-primary">Simpan Password</button>
                    </div>
                </form>
            </div>
            
            <div class="tab-pane fade" id="retention-pane" role="tabpanel" aria-labelledby="retention-tab">
                <h5 class="mb-4">Pengaturan Database</h5>
                <form action="{{ url_for('save_cleanup_settings') }}" method="POST">
                    <div class="mb-3">
                        <label for="cleanup_days" class="form-label">Durasi Penyimpanan Data (hari)</label>
                        <input type="number" class="form-control" id="cleanup_days" name="cleanup_days" min="7" value="{{ settings.cleanup_days }}" required>
                        <div class="form-text">
                            Event, gambar, dan log yang lebih lama dari batas ini akan dihapus secara otomatis setiap hari. (Minimal 7 hari).
                        </div>
                    </div>
                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-primary">Simpan Pengaturan</button>
                    </div>
                </form>
            </div>

            <div class="tab-pane fade" id="notif-pane" role="tabpanel" aria-labelledby="notif-tab">
                <h5 class="mb-4">Pengaturan Notifikasi WhatsApp</h5>
                <p class="text-muted">
                    Server API WA lokal Anda akan digunakan untuk mengirim peringatan.
                </p>
                <hr>
                <form action="{{ url_for('save_notification_settings') }}" method="POST">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" role="switch" id="whatsapp_enabled" name="whatsapp_enabled" value="true" {% if settings.whatsapp_enabled == 'true' %}checked{% endif %}>
                        <label class="form-check-label" for="whatsapp_enabled">Aktifkan Notifikasi Peringatan Offline</label>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" role="switch" id="api_fail_enabled" name="api_fail_enabled" value="true" {% if settings.api_fail_enabled == 'true' %}checked{% endif %}>
                        <label class="form-check-label" for="api_fail_enabled">Aktifkan Notifikasi API Gagal</label>
                    </div>

                    <div class="mb-3">
                        <label for="whatsapp_api_url" class="form-label">URL API WhatsApp Server</label>
                        <input type="text" class="form-control" id="whatsapp_api_url" name="whatsapp_api_url" value="{{ settings.whatsapp_api_url }}" placeholder="http://10.1.105.164:60001">
                        <div class="form-text">
                            Alamat IP dan Port server WA lokal Anda.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="whatsapp_target_number" class="form-label">Nomor WhatsApp Tujuan</label>
                        <input type="text" class="form-control" id="whatsapp_target_number" name="whatsapp_target_number" value="{{ settings.whatsapp_target_number }}" placeholder="Contoh: 62812..., 62856...">
                        <div class="form-text">
                            Bisa diisi lebih dari satu. Pisahkan dengan **koma (,)**. <br>
                            Contoh: <code>62812345,62856789</code>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="api_fail_max_retry" class="form-label">Batas Retry Notifikasi API</label>
                        <input type="number" class="form-control" id="api_fail_max_retry" name="api_fail_max_retry" min="1" value="{{ settings.api_fail_max_retry }}" required>
                        <div class="form-text">
                            Jumlah percobaan gagal sebelum mengirim notifikasi "API Gagal".
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-primary">Simpan Notifikasi</button>
                    </div>
                </form>
            </div>
            
            <div class="tab-pane fade" id="sync-pane" role="tabpanel" aria-labelledby="sync-tab">
                <h5 class="mb-4">Pengaturan Worker & Sinkronisasi</h5>
                <p class="text-muted">
                    Pengaturan yang mengontrol perilaku layanan `sync_service` (Pengambil) dan `worker_service` (Pekerja).
                </p>
                <hr>
                <form action="{{ url_for('save_sync_settings') }}" method="POST">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="worker_ping_interval" class="form-label">Interval Ping Perangkat (detik)</label>
                            <input type="number" class="form-control" id="worker_ping_interval" name="worker_ping_interval" min="5" value="{{ settings.worker_ping_interval }}" required>
                            <div class="form-text">Jeda waktu (detik) antar siklus ping ke semua perangkat.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="worker_api_interval" class="form-label">Interval Antrean API (detik)</label>
                            <input type="number" class="form-control" id="worker_api_interval" name="worker_api_interval" min="5" value="{{ settings.worker_api_interval }}" required>
                            <div class="form-text">Seberapa sering worker mencoba mengirim data `pending`.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="ping_max_fail" class="form-label">Batas Gagal Ping (kali)</label>
                            <input type="number" class="form-control" id="ping_max_fail" name="ping_max_fail" min="1" value="{{ settings.ping_max_fail }}" required>
                            <div class="form-text">Jumlah ping gagal sebelum perangkat dianggap `offline`.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="suspend_seconds" class="form-label">Durasi Penangguhan (detik)</label>
                            <input type="number" class="form-control" id="suspend_seconds" name="suspend_seconds" min="30" value="{{ settings.suspend_seconds }}" required>
                            <div class="form-text">Jeda waktu (detik) sebelum perangkat `offline` dicek kembali.</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="event_sleep_delay" class="form-label">Jeda Antar Event (detik)</label>
                            <input type="number" class="form-control" id="event_sleep_delay" name="event_sleep_delay" min="0" step="0.1" value="{{ settings.event_sleep_delay }}" required>
                            <div class="form-text">Jeda antar-event saat `sync_service` mengambil data. (Cth: 0.5 atau 1).</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="realtime_tolerance" class="form-label">Toleransi Realtime (detik)</label>
                            <input type="number" class="form-control" id="realtime_tolerance" name="realtime_tolerance" min="10" value="{{ settings.realtime_tolerance }}" required>
                            <div class="form-text">Batas waktu (detik) event dianggap 'realtime' (Default: 120).</div>
                        </div>
                        </div>
                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-primary">Simpan Sinkronisasi</button>
                    </div>
                </form>
            </div>
            
            <div class="tab-pane fade" id="advanced-pane" role="tabpanel" aria-labelledby="advanced-tab">
                <h5 class="mb-4">Pengaturan Lanjutan</h5>
                <p class="text-muted">
                    Pengaturan teknis yang memengaruhi performa jaringan dan database. Ubah dengan hati-hati.
                </p>
                <hr>
                <form action="{{ url_for('save_advanced_settings') }}" method="POST">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="poll_interval" class="form-label">Interval Pengambilan Event (detik)</label>
                            <input type="number" class="form-control" id="poll_interval" name="poll_interval" min="1" value="{{ settings.poll_interval }}" required>
                            <div class="form-text">Seberapa sering `sync_service` mengecek semua perangkat (Default: 2).</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="request_timeout" class="form-label">Batas Waktu Koneksi (detik)</label>
                            <input type="number" class="form-control" id="request_timeout" name="request_timeout" min="10" value="{{ settings.request_timeout }}" required>
                            <div class="form-text">Batas waktu untuk koneksi API dan unduh gambar (Default: 30).</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="api_queue_limit" class="form-label">Maks. Antrean API (Batch)</label>
                            <input type="number" class="form-control" id="api_queue_limit" name="api_queue_limit" min="1" value="{{ settings.api_queue_limit }}" required>
                            <div class="form-text">Jumlah event `pending` yang diambil `worker_service` (Default: 5).</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="event_batch_max" class="form-label">Maks. Event per Perangkat (Batch)</label>
                            <input type="number" class="form-control" id="event_batch_max" name="event_batch_max" min="10" value="{{ settings.event_batch_max }}" required>
                            <div class="form-text">Jumlah event maks yang diambil `sync_service` per siklus (Default: 100).</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="sync_download_retries" class="form-label">Jml Percobaan Unduh (Sync)</label>
                            <input type="number" class="form-control" id="sync_download_retries" name="sync_download_retries" min="1" value="{{ settings.sync_download_retries }}" required>
                            <div class="form-text">Jumlah percobaan `sync_service` mengunduh gambar (Default: 5).</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="worker_download_retries" class="form-label">Jml Percobaan Unduh (Worker)</label>
                            <input type="number" class="form-control" id="worker_download_retries" name="worker_download_retries" min="1" value="{{ settings.worker_download_retries }}" required>
                            <div class="form-text">Jumlah percobaan `worker_service` mengunduh ulang (Default: 2).</div>
                        </div>
                    </div>
                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-primary">Simpan Pengaturan Lanjutan</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>
{% endblock %}