{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
    .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
        transition: all 0.3s ease;
    }
    .card-border-top {
        border-top: 4px solid;
    }
    /* Warna Border Disesuaikan */
    .border-primary { border-color: #0d6efd !important; }
    .border-success { border-color: #198754 !important; }
    .border-info { border-color: #0dcaf0 !important; }
    .border-danger { border-color: #dc3545 !important; }

    /* Hapus hover effect pada list event karena sudah tidak bisa diklik */
    .list-group-item {
        cursor: default;
    }

    .activity-icon {
        width: 40px; height: 40px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%;
    }

    .card-link {
        text-decoration: none;
        color: inherit;
        display: block;
        height: 100%;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <small id="current-date" class="text-muted">Memuat tanggal...</small>
    <small id="last-updated" class="text-muted" title="Status perangkat diperbarui secara otomatis">Memuat...</small>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-6 col-lg-3">
        <a href="{{ url_for('devices') }}" class="card-link">
            <div class="card h-100 shadow-sm border-0 card-hover card-border-top border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">{{ stats.online_devices or 0 }}</h4>
                         <div class="bg-success bg-opacity-10 text-success rounded-3 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                            <i class="fas fa-wifi fa-lg"></i>
                        </div>
                    </div>
                    <p class="text-muted mb-0 mt-2">Perangkat Online</p>
                </div>
            </div>
        </a>
    </div>

    <div class="col-md-6 col-lg-3">
        <a href="{{ url_for('events', q='realtime') }}" class="card-link">
            <div class="card h-100 shadow-sm border-0 card-hover card-border-top border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">{{ stats.realtime_today or 0 }}</h4>
                        <div class="bg-primary bg-opacity-10 text-primary rounded-3 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                            <i class="fas fa-calendar-day fa-lg"></i>
                        </div>
                    </div>
                    <p class="text-muted mb-0 mt-2">Event Realtime</p>
                </div>
            </div>
        </a>
    </div>

    <div class="col-md-6 col-lg-3">
        <a href="{{ url_for('events', q='catch-up') }}" class="card-link">
            <div class="card h-100 shadow-sm border-0 card-hover card-border-top border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">{{ stats.catchup_today or 0 }}</h4>
                        <div class="bg-info bg-opacity-10 text-info rounded-3 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                            <i class="fas fa-history fa-lg"></i>
                        </div>
                    </div>
                    <p class="text-muted mb-0 mt-2">Event Susulan</p>
                </div>
            </div>
        </a>
    </div>

    <div class="col-md-6 col-lg-3">
        <a href="{{ url_for('events', q='failed') }}" class="card-link">
            <div class="card h-100 shadow-sm border-0 card-hover card-border-top border-danger">
                <div class="card-body">
                     <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">{{ stats.failed_api or 0 }}</h4>
                        <div class="bg-danger bg-opacity-10 text-danger rounded-3 d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                            <i class="fas fa-exclamation-triangle fa-lg"></i>
                        </div>
                    </div>
                    <p class="text-muted mb-0 mt-2">API Gagal Hari Ini</p>
                </div>
            </div>
        </a>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-transparent d-flex justify-content-between align-items-center py-3">
        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Pola Jam Sibuk (Rata-rata Harian)</h5>
    </div>
    <div class="card-body">
        <div style="position: relative; height: 320px; width: 100%;">
            <canvas id="busyChart"></canvas>
        </div>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-transparent d-flex justify-content-between align-items-center py-3">
        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Tren Aktivitas Harian</h5>
    </div>
    <div class="card-body">
        <div style="position: relative; height: 400px; width: 100%;">
            <canvas id="activityChart"></canvas>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-7">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Event Terbaru</h5>
                <a href="{{ url_for('events') }}" class="btn btn-sm btn-outline-primary">Lihat Semua</a>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for event in recent_events %}
                    <div class="list-group-item py-3">
                        <div class="d-flex w-100 align-items-center">
                            <div class="flex-shrink-0 me-3">
                                <div class="activity-icon
                                    {% if event.apiStatus == 'success' %} bg-success-subtle text-success-emphasis
                                    {% elif event.apiStatus == 'failed' %} bg-danger-subtle text-danger-emphasis
                                    {% else %} bg-secondary-subtle text-secondary-emphasis {% endif %}">
                                    <i class="fas
                                        {% if event.apiStatus == 'success' %} fa-check
                                        {% elif event.apiStatus == 'failed' %} fa-exclamation
                                        {% else %} fa-hourglass-start {% endif %}">
                                    </i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-bold">{{ event.name or 'N/A' }}</div>
                                <small class="text-muted">{{ event.location or 'Tanpa Lokasi' }} &bull; {{ event.deviceName }}</small>
                            </div>
                            <div class="flex-shrink-0 d-flex justify-content-end align-items-center" style="min-width: 140px; white-space: nowrap;">
                                {% if event.syncType == 'realtime' %}
                                    <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis">realtime</span>
                                {% else %}
                                    <span class="badge rounded-pill bg-info-subtle text-info-emphasis">catch-up</span>
                                {% endif %}
                                <small class="text-muted ms-2" style="width: 55px; text-align: right;">{{ event.time }}</small>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted p-5">
                        <p class="mb-0">Belum ada event terbaru.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-broadcast-tower me-2"></i>Status Perangkat</h5>
                <a href="{{ url_for('devices') }}" class="btn btn-sm btn-outline-primary">Kelola</a>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for device in devices_status %}
                    <div class="list-group-item py-3">
                         <div class="d-flex w-100 justify-content-between align-items-center">
                            <div>
                                <span class="fw-bold">{{ device.name or device.ip }}</span><br>
                                <small class="text-muted">{{ device.location or '-' }}</small>
                            </div>
                            <span id="status-{{ device.ip.replace('.', '-') }}" class="badge rounded-pill {% if device.status == 'online' %}bg-success-subtle text-success-emphasis{% elif device.status == 'offline' %}bg-secondary-subtle text-secondary-emphasis{% else %}bg-danger-subtle text-danger-emphasis{% endif %}">
                                {{ device.status }}
                            </span>
                        </div>
                    </div>
                    {% else %}
                     <div class="text-center text-muted p-5">
                        <p class="mb-0">Belum ada perangkat.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script id="chart-data-source" type="application/json">
    {{ chart_data | default({}) | tojson | safe }}
</script>
<script id="busy-data-source" type="application/json">
    {{ busy_data | default({}) | tojson | safe }}
</script>

<script>
$(document).ready(function() {
    // --- UTILS ---
    function updateTimestamp() {
        const now = new Date();
        $('#last-updated').text('Status diperbarui pada ' + now.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit', second: '2-digit'}) + ' WIB');
    }
    function setCurrentDate() {
        $('#current-date').text(new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }));
    }
    
    // --- POLLING ---
    function pollDeviceStatus() {
        $.ajax({
            url: '/api/devices_status', method: 'GET', dataType: 'json',
            success: function(devicesData) {
                devicesData.forEach(function(device) {
                    const statusBadge = $('#status-' + device.ip.replace(/\./g, '-'));
                    if (statusBadge.length) {
                        let newStatusText = device.status;
                        let newBadgeClass = (device.status === 'online') ? 'bg-success-subtle text-success-emphasis' :
                                            (device.status === 'offline') ? 'bg-secondary-subtle text-secondary-emphasis' : 'bg-danger-subtle text-danger-emphasis';
                        if (statusBadge.text().trim() !== newStatusText) {
                            statusBadge.removeClass('bg-success-subtle text-success-emphasis bg-secondary-subtle text-secondary-emphasis bg-danger-subtle text-danger-emphasis').addClass(newBadgeClass).text(newStatusText);
                        }
                    }
                });
                updateTimestamp();
            },
            error: function(xhr) { console.warn("Polling error:", xhr.status); }
        });
    }
    setCurrentDate(); pollDeviceStatus(); setInterval(pollDeviceStatus, 15000);

    // ==================================================
    // 1. CHART JAM SIBUK (STACKED BAR CHART)
    // ==================================================
    const busyCanvas = document.getElementById('busyChart');
    if (busyCanvas) {
        const ctxBusy = busyCanvas.getContext('2d');
        
        // Parsing Data
        let busyData = { realtime: [], catchup: [] };
        try { 
            const raw = document.getElementById('busy-data-source').textContent;
            busyData = JSON.parse(raw); 
            if (Array.isArray(busyData)) { busyData = { realtime: busyData, catchup: new Array(24).fill(0) }; }
        } catch (e) {}

        const hourLabels = Array.from({length: 24}, (_, i) => (i < 10 ? '0' + i : i) + ':00');

        new Chart(ctxBusy, {
            type: 'bar',
            data: {
                labels: hourLabels,
                datasets: [
                    {
                        label: 'Realtime',
                        data: busyData.realtime || [],
                        backgroundColor: '#0d6efd', // Biru Tua
                        borderRadius: 2,
                    },
                    {
                        label: 'Catch-up (Susulan)',
                        data: busyData.catchup || [],
                        backgroundColor: '#0dcaf0', // Biru Muda
                        borderRadius: 2,
                    }
                ]
            },
            options: {
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'bottom' }, 
                    tooltip: {
                        mode: 'index', 
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#212529', 
                        bodyColor: '#212529', 
                        borderColor: '#dee2e6', 
                        borderWidth: 1,
                        callbacks: {
                            footer: function(tooltipItems) {
                                let total = 0;
                                tooltipItems.forEach(function(tooltipItem) {
                                    total += tooltipItem.parsed.y;
                                });
                                return 'Total Rata-rata: ' + total.toFixed(1);
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        stacked: true, 
                        grid: { display: false } 
                    },
                    y: { 
                        stacked: true, 
                        beginAtZero: true, 
                        grid: { borderDash: [2, 4], color: '#f0f0f0' },
                        title: { display: true, text: 'Rata-rata Log' } 
                    }
                }
            }
        });
    }

    // ==================================================
    // 2. CHART TREN AKTIVITAS (LINE CHART)
    // ==================================================
    const activityCanvas = document.getElementById('activityChart');
    if (activityCanvas) {
        const ctxAct = activityCanvas.getContext('2d');
        let chartData = { labels: [], datasets: {} };
        try { chartData = JSON.parse(document.getElementById('chart-data-source').textContent); } catch (e) {}

        const dailyTotals = new Array(chartData.labels ? chartData.labels.length : 0).fill(0);
        if (chartData.datasets) {
            Object.values(chartData.datasets).forEach(dataPoints => {
                dataPoints.forEach((val, idx) => { if (typeof val === 'number') dailyTotals[idx] += val; });
            });
        }

        const formattedLabels = (chartData.labels || []).map((date, idx) => [date, `Total: ${dailyTotals[idx]}`]);

        const lineColors = ['#0d6efd', '#198754', '#dc3545', '#ffc107', '#6610f2', '#0dcaf0', '#fd7e14', '#20c997'];
        const datasets = [];
        let colorIdx = 0;
        
        if (chartData.datasets) {
            for (const [devName, pts] of Object.entries(chartData.datasets)) {
                datasets.push({
                    label: devName, data: pts,
                    borderColor: lineColors[colorIdx % lineColors.length],
                    backgroundColor: lineColors[colorIdx % lineColors.length],
                    borderWidth: 2, tension: 0.3, pointRadius: 3, pointHoverRadius: 6, fill: false
                });
                colorIdx++;
            }
        }

        new Chart(ctxAct, {
            type: 'line',
            data: { labels: formattedLabels, datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { usePointStyle: true, boxWidth: 10, padding: 20 } 
                    },
                    tooltip: {
                        mode: 'index', intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#212529', bodyColor: '#212529', borderColor: '#dee2e6', borderWidth: 1
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f0f0f0' }, title: { display: true, text: 'Jumlah Log' } },
                    x: { grid: { display: false }, ticks: { font: { size: 11 } } }
                }
            }
        });
    }
});
</script>
{% endblock %}